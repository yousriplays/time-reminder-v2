<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Alpha Timer">
    <title>Alpha Timer</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚è∞</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: white;
            --button-bg: #00ff00;
            --button-fg: black;
            --settings-bg: #3333ff;
            --settings-fg: white;
            --progress-color: #00ff00;
            --time-color: #00ff00;
            --stop-color: #ff3333;
            --chat-bg: #2a2a2a;
            --chat-input-bg: #333;
            --chat-message-bg: #444;
            --chat-message-fg: white;
        }
        [data-theme="red"] {
            --bg-color: #2a1a1a;
            --button-bg: #ff3333;
            --button-fg: white;
            --settings-bg: #990000;
            --progress-color: #ff3333;
            --time-color: #ff3333;
            --stop-color: #cc0000;
            --chat-bg: #3a1a1a;
            --chat-input-bg: #4a2a2a;
            --chat-message-bg: #5a2a2a;
            --chat-message-fg: white;
        }
        [data-theme="blue"] {
            --bg-color: #1a1a2a;
            --button-bg: #3333ff;
            --button-fg: white;
            --settings-bg: #000099;
            --progress-color: #3333ff;
            --time-color: #3333ff;
            --stop-color: #0000cc;
            --chat-bg: #1a2a3a;
            --chat-input-bg: #2a3a4a;
            --chat-message-bg: #3a4a5a;
            --chat-message-fg: white;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: Arial, sans-serif;
            font-size: 2rem;
        }
        input, select, button, textarea {
            font-family: Arial, sans-serif;
            font-size: 2rem;
        }
        .progress-bar {
            height: 40px;
            background-color: #333;
            border-radius: 20px;
            overflow: hidden;
        }
        .progress-bar div {
            height: 100%;
            background-color: var(--progress-color);
            transition: width 0.1s linear;
        }
        #chat-sidebar {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            height: 100%;
            background-color: var(--chat-bg);
            transition: right 0.3s ease;
            z-index: 50;
            display: flex;
            flex-direction: column;
        }
        #chat-sidebar.open {
            right: 0;
        }
        #chat-toggle {
            position: fixed;
            bottom: 16px;
            right: 16px;
            z-index: 60;
            font-size: 1.5rem;
            padding: 12px;
            transition: transform 0.3s ease;
        }
        #chat-toggle.open {
            transform: translateX(-600px);
        }
        #chat-toggle::after {
            content: attr(data-message-count);
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--stop-color);
            color: white;
            border-radius: 50%;
            font-size: 1rem;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .chat-message {
            background-color: var(--chat-message-bg);
            color: var(--chat-message-fg);
            padding: 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
        }
        .chat-message img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
        }
        .chat-message.mine {
            align-self: flex-end;
            background-color: var(--button-bg);
            color: var(--button-fg);
        }
        .chat-message .message-actions {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: row;
            gap: 4px;
        }
        .chat-message.mine .message-actions {
            left: -96px;
        }
        .chat-message:not(.mine) .message-actions {
            right: -96px;
        }
        .chat-message .message-actions button {
            background-color: var(--chat-input-bg);
            color: var(--text-color);
            border: none;
            border-radius: 4px;
            padding: 4px;
            font-size: 1rem;
            cursor: pointer;
        }
        .chat-message .reply-quote {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-left: 4px solid var(--button-bg);
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .chat-message .edit-history, .chat-message .deleted-message {
            font-size: 0.8em;
            color: #aaa;
            margin-top: 8px;
        }
        #chat-input-area {
            display: flex;
            padding: 16px;
            background-color: var(--chat-input-bg);
            gap: 8px;
        }
        #chat-input {
            flex-grow: 1;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px;
            font-size: 1.5rem;
            resize: none;
            overflow-y: auto;
            min-height: 40px;
            max-height: 200px;
            line-height: 1.5;
        }
        #chat-auth {
            padding: 16px;
            background-color: var(--chat-input-bg);
        }
        #chat-auth input {
            width: 100%;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px;
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        #chat-auth label {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-8">
    <!-- Chat Toggle Button -->
    <button id="chat-toggle" class="rounded-full font-bold" style="background-color: var(--button-bg); color: var(--button-fg);" data-message-count="0">üí¨</button>
    <!-- Chat Sidebar -->
    <div id="chat-sidebar">
        <div id="chat-auth" class="hidden">
            <div id="chat-password-section">
                <input id="chat-password" type="text" placeholder="Enter daily password">
                <button id="chat-login" class="w-full mt-4 px-4 py-2 font-bold rounded" style="background-color: var(--button-bg); color: var(--button-fg);">Submit Password</button>
            </div>
            <div id="chat-second-password-section" class="hidden">
                <input id="chat-second-password" type="text" placeholder="Re-enter daily password">
                <button id="chat-second-login" class="w-full mt-4 px-4 py-2 font-bold rounded" style="background-color: var(--button-bg); color: var(--button-fg);">Submit Second Password</button>
            </div>
            <div id="user-password-section" class="hidden">
                <label for="user-password">Enter user password</label>
                <input id="user-password" type="text" placeholder="">
                <button id="user-login" class="w-full mt-4 px-4 py-2 font-bold rounded" style="background-color: var(--button-bg); color: var(--button-fg);">Login as User</button>
            </div>
        </div>
        <div id="chat-content" class="flex flex-col h-full hidden">
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <textarea id="chat-input" placeholder="Type a message..."></textarea>
                <button id="chat-send" class="px-4 py-2 font-bold rounded" style="background-color: var(--button-bg); color: var(--button-fg);">Send</button>
                <button id="chat-photo" class="px-4 py-2 font-bold rounded" style="background-color: var(--settings-bg); color: var(--settings-fg);">üñºÔ∏è</button>
                <button id="chat-logout" class="px-4 py-2 font-bold rounded" style="background-color: var(--settings-bg); color: var(--settings-fg);">Log Out</button>
                <input id="chat-photo-input" type="file" accept="image/*" class="hidden">
            </div>
        </div>
    </div>
    <div id="main-container" class="w-full max-w-2xl">
        <!-- Timer Page -->
        <div id="timer-page" class="flex flex-col items-center">
            <p class="text-pink-400 italic text-3xl mb-8">For the most beautiful girl in the world, Hiba üíñ</p>
            <div class="flex space-x-8 mb-8">
                <div class="text-center">
                    <label class="block text-3xl mb-2">HOURS</label>
                    <input id="hours" type="number" min="0" max="99" value="0" class="w-32 text-center text-4xl bg-gray-800 text-white border-none rounded p-2">
                </div>
                <div class="text-center">
                    <label class="block text-3xl mb-2">MINUTES</label>
                    <input id="minutes" type="number" min="0" max="59" value="1" class="w-32 text-center text-4xl bg-gray-800 text-white border-none rounded p-2">
                </div>
                <div class="text-center">
                    <label class="block text-3xl mb-2">SECONDS</label>
                    <input id="seconds" type="number" min="0" max="59" value="0" class="w-32 text-center text-4xl bg-gray-800 text-white border-none rounded p-2">
                </div>
            </div>
            <div class="mb-8 w-full text-center">
                <label class="block text-3xl mb-2">INTERVAL (MINUTES)</label>
                <input id="interval" type="number" min="0" step="0.1" value="0.5" class="w-40 text-center text-4xl bg-gray-800 text-white border-none rounded p-2">
            </div>
            <div class="progress-bar w-full max-w-md mb-8">
                <div id="progress" class="w-0"></div>
            </div>
            <p id="time-display" class="text-4xl mb-8" style="color: var(--time-color);">TIME LEFT: 0:00</p>
            <div class="flex space-x-8">
                <button id="start-stop" class="px-8 py-4 text-2xl font-bold rounded" style="background-color: var(--button-bg); color: var(--button-fg);">START TIMER</button>
                <button id="settings-btn" class="px-8 py-4 text-2xl font-bold rounded" style="background-color: var(--settings-bg); color: var(--settings-fg);">SETTINGS</button>
            </div>
        </div>
        <!-- Settings Page -->
        <div id="settings-page" class="flex flex-col items-center hidden">
            <p class="text-pink-400 italic text-3xl mb-8">For the most beautiful girl in the world, Hiba üíñ</p>
            <div class="w-full mb-8">
                <label class="block text-3xl mb-2">AVAILABLE SOUNDS</label>
                <select id="sound-choice" class="w-full p-4 text-2xl bg-gray-800 text-white border-none rounded"></select>
                <div class="flex space-x-8 mt-4">
                    <button id="add-sound" class="px-8 py-2 text-2xl font-bold rounded" style="background-color: var(--button-bg); color: var(--button-fg);">ADD SOUND</button>
                    <button id="remove-sound" class="px-8 py-2 text-2xl font-bold bg-red-600 text-white rounded">REMOVE SOUND</button>
                </div>
                <input id="sound-input" type="file" accept="audio/*" class="hidden">
            </div>
            <div class="w-full mb-8">
                <label class="block text-3xl mb-2">SELECT THEME</label>
                <div class="flex space-x-4">
                    <button class="theme-btn px-8 py-2 text-2xl font-bold rounded bg-green-500 text-black" data-theme="dark">DARK</button>
                    <button class="theme-btn px-8 py-2 text-2xl font-bold rounded bg-red-500 text-white" data-theme="red">RED</button>
                    <button class="theme-btn px-8 py-2 text-2xl font-bold rounded bg-blue-500 text-white" data-theme="blue">BLUE</button>
                </div>
            </div>
            <div class="w-full mb-8">
                <label class="block text-3xl mb-2">DEFAULT INTERVAL (MIN)</label>
                <input id="default-interval" type="number" min="0" step="0.1" value="0.5" class="w-40 text-center text-4xl bg-gray-800 text-white border-none rounded p-2">
            </div>
            <div class="w-full mb-8">
                <label class="block text-3xl mb-2">DEFAULT TIMER VALUES</label>
                <div class="flex space-x-8">
                    <div>
                        <label class="block text-2xl">HOURS</label>
                        <input id="default-hours" type="number" min="0" max="99" value="0" class="w-32 text-center text-4xl bg-gray-800 text-white border-none rounded p-2">
                    </div>
                    <div>
                        <label class="block text-2xl">MINUTES</label>
                        <input id="default-minutes" type="number" min="0" max="59" value="1" class="w-32 text-center text-4xl bg-gray-800 text-white border-none rounded p-2">
                    </div>
                    <div>
                        <label class="block text-2xl">SECONDS</label>
                        <input id="default-seconds" type="number" min="0" max="59" value="0" class="w-32 text-center text-4xl bg-gray-800 text-white border-none rounded p-2">
                    </div>
                </div>
            </div>
            <div class="flex flex-col space-y-4">
                <button id="save-settings" class="px-8 py-2 text-2xl font-bold rounded" style="background-color: var(--settings-bg); color: var(--settings-fg);">SAVE NOW</button>
                <button id="back-to-timer" class="px-8 py-2 text-2xl font-bold rounded" style="background-color: var(--button-bg); color: var(--button-fg);">BACK TO TIMER</button>
            </div>
        </div>
    </div>
    <script>
        // Initialize Socket.IO
        const socket = io();

        // Default sound
        const defaultSound = 'tinnn.mp3';

        // Password generation
        const flirtWords = {
            'Monday': 'charming',
            'Tuesday': 'gorgeous',
            'Wednesday': 'sweetheart',
            'Thursday': 'darling',
            'Friday': 'lovely',
            'Saturday': 'beautiful',
            'Sunday': 'angel'
        };

        function generateDailyPassword(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
            const flirtWord = flirtWords[dayName] || 'lovely';
            return `${year}${month}${day}-${flirtWord}`;
        }

        let currentUser = null;
        let replyToMessageId = null;
        let firstChatPassword = null;
        let messages = [];
        let deletedMessages = [];

        // Check last chat access
        function requiresDoublePassword() {
            const lastAccess = localStorage.getItem('lastChatAccess');
            if (!lastAccess) return true;
            const lastAccessTime = parseInt(lastAccess);
            const now = Date.now();
            const fiveHours = 5 * 60 * 60 * 1000;
            return (now - lastAccessTime) > fiveHours;
        }

        function recordChatAccess() {
            localStorage.setItem('lastChatAccess', Date.now().toString());
        }

        // Configuration management
        function loadConfig() {
            const defaultConfig = {
                hours: '0',
                minutes: '1',
                seconds: '0',
                interval: '0.5',
                sound_list: ['tinnn.mp3'],
                selected_sound: 'tinnn.mp3',
                theme: 'dark'
            };
            return JSON.parse(localStorage.getItem('timer_config')) || defaultConfig;
        }

        function saveConfig(config) {
            localStorage.setItem('timer_config', JSON.stringify(config));
        }

        function updateMessageCount() {
            const unreadCount = messages.filter(m => !m.readBy || !m.readBy.includes(currentUser)).length;
            document.getElementById('chat-toggle').setAttribute('data-message-count', unreadCount);
        }

        function markMessagesAsRead() {
            if (currentUser) {
                socket.emit('markRead', currentUser);
            }
        }

        function renderChatMessages() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            messages.forEach((msg, index) => {
                const div = document.createElement('div');
                div.className = `chat-message ${msg.user === currentUser ? 'mine' : ''}`;
                let content = `<strong>${msg.user}:</strong> ${msg.text}`;
                if (msg.replyTo !== null) {
                    const repliedMsg = messages.find(m => m.id === msg.replyTo) || deletedMessages.find(m => m.id === msg.replyTo);
                    if (repliedMsg) {
                        content = `<div class="reply-quote"><strong>${repliedMsg.user}:</strong> ${repliedMsg.text}</div>` + content;
                    }
                }
                if (msg.image) {
                    content += `<img src="${msg.image}" alt="Image">`;
                }
                if (msg.editHistory && msg.editHistory.length > 0 && currentUser === '7abibti') {
                    content += `<div class="edit-history">Edited: ${msg.editHistory.map(e => e.text).join(' ‚Üí ')}</div>`;
                }
                div.innerHTML = content;
                const actions = document.createElement('div');
                actions.className = 'message-actions';
                actions.dataset.messageId = msg.id;
                if (msg.user === currentUser) {
                    actions.innerHTML += `<button class="edit-btn" data-id="${msg.id}">‚úèÔ∏è</button>`;
                    actions.innerHTML += `<button class="delete-btn" data-id="${msg.id}">üóëÔ∏è</button>`;
                }
                actions.innerHTML += `<button class="reply-btn" data-id="${msg.id}">‚Ü©Ô∏è</button>`;
                div.appendChild(actions);
                chatMessages.appendChild(div);
            });
            if (currentUser === '7abibti') {
                deletedMessages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'chat-message deleted-message';
                    let content = `<strong>Deleted by ${msg.user}:</strong> ${msg.text}`;
                    if (msg.image) {
                        content += `<img src="${msg.image}" alt="Deleted Image">`;
                    }
                    div.innerHTML = content;
                    chatMessages.appendChild(div);
                });
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
            updateMessageCount();
        }

        // Theme management
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
        }

        // Sound management
        const soundCache = new Map();
        let currentSound = null;

        async function loadSound(soundName) {
            if (soundCache.has(soundName)) {
                currentSound = soundCache.get(soundName);
                return;
            }
            try {
                const audio = new Audio(soundName);
                await audio.load();
                soundCache.set(soundName, audio);
                currentSound = audio;
            } catch (e) {
                alert(`Could not load sound: ${e.message}`);
                currentSound = null;
            }
        }

        function playSound() {
            if (currentSound) {
                currentSound.currentTime = 0;
                currentSound.play().catch(e => console.error('Sound play error:', e));
            }
        }

        // Timer logic
        let timerRunning = false;
        let stopFlag = false;
        let elapsedTime = 0;
        let timerInterval = null;

        function updateProgressBar(value, max) {
            const progress = document.getElementById('progress');
            progress.style.width = `${(value / max) * 100}%`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `TIME LEFT: ${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function runTimer(totalSeconds, intervalSeconds) {
            elapsedTime = elapsedTime || 0;
            let nextSoundTime = intervalSeconds || totalSeconds + 1;

            timerInterval = setInterval(() => {
                if (stopFlag || elapsedTime >= totalSeconds) {
                    clearInterval(timerInterval);
                    timerRunning = false;
                    const startStopBtn = document.getElementById('start-stop');
                    startStopBtn.textContent = 'START TIMER';
                    startStopBtn.style.backgroundColor = getComputedStyle(document.body).getPropertyValue('--button-bg');
                    if (stopFlag) {
                        document.getElementById('time-display').textContent = 'TIMER STOPPED ‚õî';
                    } else {
                        document.getElementById('time-display').textContent = 'DONE ‚úÖ';
                        playSound();
                    }
                    return;
                }

                elapsedTime++;
                updateProgressBar(elapsedTime, totalSeconds);
                document.getElementById('time-display').textContent = formatTime(totalSeconds - elapsedTime);

                if (elapsedTime === nextSoundTime && elapsedTime < totalSeconds) {
                    playSound();
                    nextSoundTime += intervalSeconds;
                }
            }, 1000);
        }

        function toggleTimer() {
            if (timerRunning) {
                stopFlag = true;
                timerRunning = false;
            } else {
                const hours = parseInt(document.getElementById('hours').value) || 0;
                const minutes = parseInt(document.getElementById('minutes').value) || 0;
                const seconds = parseInt(document.getElementById('seconds').value) || 0;
                const interval = parseFloat(document.getElementById('interval').value) || 0;

                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                const intervalSeconds = Math.round(interval * 60);

                if (totalSeconds <= 0) {
                    document.getElementById('time-display').textContent = 'SET TIME FIRST';
                    return;
                }

                timerRunning = true;
                stopFlag = false;
                const startStopBtn = document.getElementById('start-stop');
                startStopBtn.textContent = 'STOP TIMER';
                startStopBtn.style.backgroundColor = getComputedStyle(document.body).getPropertyValue('--stop-color');
                updateProgressBar(0, totalSeconds);
                runTimer(totalSeconds, intervalSeconds);
            }
        }

        // UI setup
        const config = loadConfig();
        applyTheme(config.theme);
        document.getElementById('hours').value = config.hours;
        document.getElementById('minutes').value = config.minutes;
        document.getElementById('seconds').value = config.seconds;
        document.getElementById('interval').value = config.interval;
        document.getElementById('default-hours').value = config.hours;
        document.getElementById('default-minutes').value = config.minutes;
        document.getElementById('default-seconds').value = config.seconds;
        document.getElementById('default-interval').value = config.interval;

        const soundChoice = document.getElementById('sound-choice');
        soundChoice.innerHTML = config.sound_list.map(sound => `<option value="${sound}">${sound}</option>`).join('');
        soundChoice.value = config.selected_sound;
        loadSound(config.selected_sound);
        updateMessageCount();

        // Chat event listeners
        const chatSidebar = document.getElementById('chat-sidebar');
        const chatToggle = document.getElementById('chat-toggle');
        const chatAuth = document.getElementById('chat-auth');
        const chatContent = document.getElementById('chat-content');
        const chatPasswordSection = document.getElementById('chat-password-section');
        const chatSecondPasswordSection = document.getElementById('chat-second-password-section');
        const userPasswordSection = document.getElementById('user-password-section');
        const chatPassword = document.getElementById('chat-password');
        const chatSecondPassword = document.getElementById('chat-second-password');
        const userPassword = document.getElementById('user-password');
        const chatLogin = document.getElementById('chat-login');
        const chatSecondLogin = document.getElementById('chat-second-login');
        const userLogin = document.getElementById('user-login');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const chatPhoto = document.getElementById('chat-photo');
        const chatPhotoInput = document.getElementById('chat-photo-input');
        const chatLogout = document.getElementById('chat-logout');

        chatToggle.addEventListener('click', () => {
            chatSidebar.classList.toggle('open');
            chatToggle.classList.toggle('open');
            if (chatSidebar.classList.contains('open')) {
                if (!currentUser) {
                    chatAuth.classList.remove('hidden');
                    chatContent.classList.add('hidden');
                    chatPasswordSection.classList.remove('hidden');
                    chatSecondPasswordSection.classList.add('hidden');
                    userPasswordSection.classList.add('hidden');
                    chatPassword.value = '';
                    chatSecondPassword.value = '';
                    userPassword.value = '';
                } else {
                    chatAuth.classList.add('hidden');
                    chatContent.classList.remove('hidden');
                    renderChatMessages();
                }
            } else {
                chatAuth.classList.add('hidden');
                chatContent.classList.add('hidden');
            }
        });

        chatLogin.addEventListener('click', () => {
            const input = chatPassword.value.trim();
            const today = new Date();
            const dailyPassword = generateDailyPassword(today);
            if (input === dailyPassword) {
                firstChatPassword = input;
                if (requiresDoublePassword()) {
                    chatPasswordSection.classList.add('hidden');
                    chatSecondPasswordSection.classList.remove('hidden');
                    userPasswordSection.classList.add('hidden');
                    chatSecondPassword.focus();
                } else {
                    recordChatAccess();
                    chatPasswordSection.classList.add('hidden');
                    chatSecondPasswordSection.classList.add('hidden');
                    userPasswordSection.classList.remove('hidden');
                    userPassword.focus();
                }
                chatPassword.value = '';
            } else {
                alert('Invalid password. Ask for the daily password.');
            }
        });

        chatSecondLogin.addEventListener('click', () => {
            const input = chatSecondPassword.value.trim();
            const today = new Date();
            const dailyPassword = generateDailyPassword(today);
            if (input === dailyPassword && input === firstChatPassword) {
                recordChatAccess();
                chatPasswordSection.classList.add('hidden');
                chatSecondPasswordSection.classList.add('hidden');
                userPasswordSection.classList.remove('hidden');
                chatSecondPassword.value = '';
                userPassword.focus();
            } else {
                alert('Second password incorrect or does not match.');
                chatSecondPassword.value = '';
            }
        });

        userLogin.addEventListener('click', () => {
            const input = userPassword.value.trim();
            if (['7obi', '7abibti'].includes(input)) {
                currentUser = input;
                socket.emit('join', input);
                chatAuth.classList.add('hidden');
                chatContent.classList.remove('hidden');
                user Hab√≠a: Password.value = '';
                renderChatMessages();
            } else {
                alert('Invalid user password.');
                userPassword.value = '';
            }
        });

        chatLogout.addEventListener('click', () => {
            socket.emit('leave', currentUser);
            currentUser = null;
            firstChatPassword = null;
            chatAuth.classList.remove('hidden');
            chatContent.classList.add('hidden');
            chatPasswordSection.classList.remove('hidden');
            chatSecondPasswordSection.classList.add('hidden');
            userPasswordSection.classList.add('hidden');
            chatPassword.value = '';
            chatSecondPassword.value = '';
            userPassword.value = '';
            chatInput.value = '';
            chatInput.style.height = '40px';
            replyToMessageId = null;
            chatInput.placeholder = 'Type a message...';
        });

        chatSend.addEventListener('click', () => {
            const text = chatInput.value.trim();
            if (text) {
                const newMessage = {
                    id: Date.now(),
                    user: currentUser,
                    text,
                    timestamp: Date.now(),
                    replyTo: replyToMessageId,
                    editHistory: [],
                    readBy: [currentUser]
                };
                socket.emit('chatMessage', newMessage);
                chatInput.value = '';
                chatInput.style.height = '40px';
                replyToMessageId = null;
                chatInput.placeholder = 'Type a message...';
                if (text.toLowerCase() === 'wow') {
                    alert('Wow! üòç');
                }
            }
        });

        chatPhoto.addEventListener('click', () => {
            chatPhotoInput.click();
        });

        chatPhotoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('image', file);
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.imageUrl) {
                        const newMessage = {
                            id: Date.now(),
                            user: currentUser,
                            text: '',
                            image: data.imageUrl,
                            timestamp: Date.now(),
                            replyTo: replyToMessageId,
                            editHistory: [],
                            readBy: [currentUser]
                        };
                        socket.emit('chatMessage', newMessage);
                        replyToMessageId = null;
                        chatInput.placeholder = 'Type a message...';
                    }
                })
                .catch(e => console.error('Image upload failed:', e));
            }
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatSend.click();
            }
        });

        chatInput.addEventListener('input', () => {
            chatInput.style.height = '40px';
            chatInput.style.height = `${Math.min(chatInput.scrollHeight, 200)}px`;
        });

        // Message actions (edit, delete, reply)
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            const target = e.target;
            const messageId = parseInt(target.dataset.id);
            const message = messages.find(m => m.id === messageId);

            if (!message) return;

            if (target.classList.contains('edit-btn') && message.user === currentUser) {
                const newText = prompt('Edit message:', message.text);
                if (newText !== null && newText.trim()) {
                    socket.emit('editMessage', {
                        id: messageId,
                        newText: newText.trim()
                    });
                }
            } else if (target.classList.contains('delete-btn') && message.user === currentUser) {
                socket.emit('deleteMessage', messageId);
            } else if (target.classList.contains('reply-btn')) {
                replyToMessageId = messageId;
                const repliedMsg = messages.find(m => m.id === messageId) || deletedMessages.find(m => m.id === messageId);
                if (repliedMsg) {
                    chatInput.placeholder = `Replying to ${repliedMsg.user}: ${repliedMsg.text.slice(0, 20)}...`;
                    chatInput.focus();
                }
            }
        });

        // Socket.IO events
        socket.on('messages', (msgs) => {
            messages = msgs;
            renderChatMessages();
        });

        socket.on('deletedMessages', (msgs) => {
            deletedMessages = msgs;
            renderChatMessages();
        });

        socket.on('chatMessage', (msg) => {
            messages.push(msg);
            renderChatMessages();
        });

        socket.on('messageEdited', (data) => {
            const message = messages.find(m => m.id === data.id);
            if (message) {
                message.editHistory.push({ text: message.text, timestamp: Date.now() });
                message.text = data.newText;
                message.timestamp = Date.now();
                renderChatMessages();
            }
        });

        socket.on('messageDeleted', (messageId) => {
            const message = messages.find(m => m.id === messageId);
            if (message) {
                deletedMessages.push({ ...message });
                messages = messages.filter(m => m.id !== messageId);
                renderChatMessages();
            }
        });

        socket.on('readStatus', (data) => {
            messages = data.messages;
            renderChatMessages();
        });

        // Timer event listeners
        document.getElementById('start-stop').addEventListener('click', toggleTimer);
        document.getElementById('settings-btn').addEventListener('click', () => {
            document.getElementById('timer-page').classList.add('hidden');
            document.getElementById('settings-page').classList.remove('hidden');
        });
        document.getElementById('back-to-timer').addEventListener('click', () => {
            document.getElementById('settings-page').classList.add('hidden');
            document.getElementById('timer-page').classList.remove('hidden');
        });
        document.getElementById('save-settings').addEventListener('click', () => {
            const newConfig = {
                hours: document.getElementById('default-hours').value,
                minutes: document.getElementById('default-minutes').value,
                seconds: document.getElementById('default-seconds').value,
                interval: document.getElementById('default-interval').value,
                sound_list: Array.from(soundChoice.options).map(opt => opt.value),
                selected_sound: soundChoice.value,
                theme: document.body.getAttribute('data-theme')
            };
            saveConfig(newConfig);
            document.getElementById('hours').value = newConfig.hours;
            document.getElementById('minutes').value = newConfig.minutes;
            document.getElementById('seconds').value = newConfig.seconds;
            document.getElementById('interval').value = newConfig.interval;
            alert('Settings saved successfully.');
        });
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const theme = btn.getAttribute('data-theme');
                applyTheme(theme);
                saveConfig({ ...loadConfig(), theme });
            });
        });
        document.getElementById('add-sound').addEventListener('click', () => {
            document.getElementById('sound-input').click();
        });
        document.getElementById('sound-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                const soundName = file.name;
                if (!config.sound_list.includes(soundName)) {
                    config.sound_list.push(soundName);
                    soundChoice.innerHTML += `<option value="${soundName}">${soundName}</option>`;
                }
                soundChoice.value = soundName;
                loadSound(url);
                saveConfig({ ...loadConfig(), sound_list: config.sound_list, selected_sound: soundName });
            }
        });
        document.getElementById('remove-sound').addEventListener('click', () => {
            const selected = soundChoice.value;
            if (config.sound_list.length <= 1) {
                alert('You must keep at least one sound file.');
                return;
            }
            if (config.sound_list.includes(selected)) {
                config.sound_list = config.sound_list.filter(s => s !== selected);
                soundChoice.innerHTML = config.sound_list.map(sound => `<option value="${sound}">${sound}</option>`).join('');
                soundChoice.value = config.sound_list[0];
                loadSound(config.sound_list[0]);
                saveConfig({ ...loadConfig(), sound_list: config.sound_list, selected_sound: config.sound_list[0] });
            }
        });
        soundChoice.addEventListener('change', () => {
            loadSound(soundChoice.value);
            saveConfig({ ...loadConfig(), selected_sound: soundChoice.value });
        });

        // Input validation
        function restrictInput(input, maxLength, maxValue) {
            input.addEventListener('input', () => {
                let value = input.value.replace(/\D/g, '');
                if (value.length > maxLength) value = value.slice(0, maxLength);
                if (parseInt(value) > maxValue) value = maxValue.toString();
                input.value = value || '0';
            });
        }

        restrictInput(document.getElementById('hours'), 2, 99);
        restrictInput(document.getElementById('minutes'), 2, 59);
        restrictInput(document.getElementById('seconds'), 2, 59);
        restrictInput(document.getElementById('default-hours'), 2, 99);
        restrictInput(document.getElementById('default-minutes'), 2, 59);
        restrictInput(document.getElementById('default-seconds'), 2, 59);

        // Service worker registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').catch(e => console.error('Service Worker registration failed:', e));
        }
    </script>
</body>
</html>
